-# = render 'layouts/header'
= render 'shared/niches/header', niche: @niche
- current_user_is_following_niche = user_signed_in? ? current_user.following?(@niche) : false
-# check_and_set_is_postable returns true else returns number of followers to avoid extra queries
- tmp = @niche.check_and_set_is_postable_and_get_nb_followers
- is_postable = tmp[:is_postable]
- nb_followers = tmp[:nb_followers]
%div{class: "mt-10 flex justify-center pb-10"}
  %div{class: "max-w-screen-lg w-full flex"}
    %div{class: "w-2/3 pr-12"}
      - if is_postable
        - if @solutions.any?

          - if @niche.tags.present?
            %div{class: "flex items-center #{params[:tag].present? ? "text-base" : "text-xs pb-4"}"}
              %h2{class: "font-semibold pb-4 flex-shrink-0"}
                Tags:
              - if params[:tag]
                %div{class: "flex-shrink-0 text-black mr-1 ml-3 pb-4 font-medium"}
                  = params[:tag]
              %div{class: "ml-3 space-x-4 overflow-x-scroll flex items-center pb-4"}
                - @niche.tags.each do |tag|
                  = link_to_unless_current(tag.name, [@niche, tag: tag.name], class: "flex-shrink-0 text-gray-600 hover:text-black") do end
          - if params[:tag]
            = render partial: "solutions/niche_preview", collection: @solutions, as: :solution, cached: true
          - else
            - if @solutions.today.any?
              %h2{class: "w-full font-bold text-2xl mb-6 leading-none"}
                Today
              = render partial: "solutions/niche_preview", collection: @solutions.today, as: :solution, cached: true
              %div{class: "mt-6"}
            - if @solutions.past_week.any?
              %h2{class: "w-full font-bold text-2xl mb-6 leading-none"}
                Past Week
              = render partial: "solutions/niche_preview", collection: @solutions.past_week, as: :solution, cached: true
              %div{class: "mt-6"}
            - if @solutions.past_month.any?
              %h2{class: "w-full font-bold text-2xl mb-6 leading-none"}
                Past Month
              = render partial: "solutions/niche_preview", collection: @solutions.past_month, as: :solution, cached: true

        - else
          -# Postable, but no solutions
          %div{class: "mt-4 w-full font-semibold text-2xl leading-none text-center"}
            No solutions to learn from yet ðŸ˜”

          %div{class: "mt-20 w-full text-xl leading-none text-center"}
            Have a problem you need a solution for?<br/>
            %div{class: "mt-4"}
              = link_to "Make a request", new_request_path(code: @niche.code), class: "px-0.5 pt-1 user-link"



      - else
        -# Niche is not postable to
        %div{class: "w-full flex flex-col items-center"}
          %div{class: "mt-4 w-full leading-none text-center"}
            %div{class: "font-semibold text-2xl"}
              This community is currently locked ðŸ”’
          %div{class: "mt-6 text-6xl text-secondary diagonal-fractions"}
            = "#{40 - nb_followers}/40"
          -# %div{class: "ml-2 text-lg"}
          %div{class: "mt-2 text-xl"}
            followers needed to unlock
          -# (Posting is allowed once a community has 40 followers. This community )

        - if user_signed_in?
          -# = "#{link_to "Follow", [:follow, @niche], class: "user-link px-1"}"
          - if !current_user_is_following_niche
            %div{class: "mt-10 w-full text-center"}
              = link_to "Follow community", [:follow, @niche], class: "flex-shrink-0 border-b-3 border-secondary px-0.5 text-xl font-medium leading-4 transition-all hover:bg-secondary hover:text-white pt-1 tracking-wide"
          - else
            -# %div{class: "mt-10 w-full text-center text-xl"}
            -#   Invite your friends to unlock this community quicker ðŸ”“

        - else
          %div{class: "mt-20 px-20 text-lg text-center"}
            = "Sign up and follow the #{@niche.title} community ðŸ‘‡"

          = form_with url: [:follow, @niche], method: :get, local: true, html: {class: "mt-4 w-full flex justify-center px-28"} do |f|
            %input{type: "email", name: "user[email]",
              placeholder: "Email",
              autocomplete: "email",
              class: "block text-gray-900 w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 hover:border-indigo-300 hover:ring hover:ring-indigo-200 hover:ring-opacity-50"}
            = f.submit "Sign Up & Follow", class: "flex-shrink-0 ml-2 py-2 px-4 bg-primary text-white rounded cursor-pointer hover:bg-opacity-90"




    %div{class: "w-1/3 flex-shrink-0 flex flex-wrap"}
      %div{class: "w-full flex flex-col space-y-10 rounded-sm"}
        %div{class: "w-full pt-3 pb-6 px-6 bg-white border border-gray-400 rounded"}
          %div{class: "w-full flex justify-between"}
            %h2{class: "w-full text-base font-bold text-sm text-gray-900"}
              = "About #{niche_type}"
            - if user_signed_in?
              - if current_user_is_following_niche
                = link_to "Following", [:unfollow, @niche], class: "flex-shrink-0 border-b-0 text-gray-700 border-secondary px-0.5 text-sm font-medium leading-4 transition-all hover:bg-secondary hover:text-white pt-1 tracking-wide"
              - else
                = link_to "Follow", [:follow, @niche], class: "flex-shrink-0 border-b-3 border-secondary px-0.5 text-sm font-medium leading-4 transition-all hover:bg-secondary hover:text-white pt-1 tracking-wide"
          %div{class: "mt-4 w-full text-sm", "data-controller": "toggle"}
            %div{class: "mb-2 -ml-4 flex w-full items-center hover:text-black hover:font-medium hover:cursor-pointer", "data-action": 'click->toggle#toggle touch->toggle#toggle'}
              %div{class: "w-4 h-4 hover:cursor-pointer", "data-toggle-target": "toggleable"}
                = svg_tag "chevron-right"

              %div{class: "hidden w-4 h-4 hover:cursor-pointer", "data-toggle-target": "toggleable"}
                = svg_tag "chevron-down"
              %div{class: "hover:cursor-pointer"}
                Description
            = simple_format @niche.description.gsub(/\n/, '<br/>').html_safe, class: "pb-3 hidden", "data-toggle-target": "toggleable"

          %div{class: "mt-4 w-full text-sm", "data-controller": "toggle"}
            %div{class: "mb-2 -ml-4 flex w-full items-center hover:text-black hover:font-medium hover:cursor-pointer", "data-action": 'click->toggle#toggle touch->toggle#toggle'}
              %div{class: "w-4 h-4 hover:cursor-pointer", "data-toggle-target": "toggleable"}
                = svg_tag "chevron-right"

              %div{class: "hidden w-4 h-4 hover:cursor-pointer", "data-toggle-target": "toggleable"}
                = svg_tag "chevron-down"
              %div{class: "hover:cursor-pointer"}
                Keywords
            %div{class: "pb-3 hidden space-y-3", "data-toggle-target": "toggleable"}
              = simple_format @niche.all_keywords.gsub(/;/, "\n\n"), wrapper_tag: "div"
            %div{class: "hidden", "data-toggle-target": "toggleable"}
              -# = form_with url: suggested_keywords_path, method: :post, local: true, html: {class: "flex w-full items-center"} do |f|
              = form_with model: @suggested_keyword, method: :post, local: true, html: {class: "flex w-full items-center"} do |f|
                -# = f.hidden_field "type", value: @niche.class.to_s
                = f.hidden_field "#{@niche.class.to_s.downcase}_slug", value: @niche.slug
                -# = f.hidden_field "niche_id", value: @niche.id
                = f.text_field :keyword, placeholder: "New keyword", class: "block text-sm text-gray-900 w-3/4 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 hover:border-indigo-300 hover:ring hover:ring-indigo-200 hover:ring-opacity-50"
                -# %input{type: "text",
                -#       name: "suggested_keyword[keyword]",
                -#       class: "block text-sm text-gray-900 w-3/4 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 hover:border-indigo-300 hover:ring hover:ring-indigo-200 hover:ring-opacity-50",
                -#       placeholder: "New keyword"}
                = f.submit "Suggest", class: "flex-shrink-0 ml-2 py-2 px-4 bg-primary text-white rounded cursor-pointer hover:bg-opacity-90"



        - if is_postable && @niche.solutions.present?
          - if !user_signed_in?
            %div
              %div{class: "text-lg text-center"}
                Sign up and follow this community ðŸ‘‡
                -# Get notified weekly about top solutions / requests posted to this community ðŸ‘‡
              = form_with url: [:follow, @niche], method: :get, local: true, html: {class: "mt-4 flex items-center"} do |f|
                %input{type: "email", name: "user[email]",
                  placeholder: "Email",
                  autocomplete: "email",
                  class: "block text-gray-900 w-3/4 rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 hover:border-indigo-300 hover:ring hover:ring-indigo-200 hover:ring-opacity-50"}
                = f.submit "Sign Up", class: "flex-shrink-0 ml-2 p-2 bg-primary text-white rounded cursor-pointer hover:bg-opacity-90"


          %div{class: "text-lg w-full text-center"}
            Have a problem you need a solution for?
            %div{class: "mt-2 flex leading-none w-full justify-center"}
              = link_to "Make a request", new_request_path(code: @niche.code), class: "user-link px-0.5 pt-1 items-center"

        %div{class: "py-3 px-4 bg-white border border-gray-400 rounded"}
          %div{class: "w-full text-base font-medium"}
            Popular general tags
          %div{class: "mt-3 text-sm space-y-1 flex flex-wrap space-x-5"}
            - cache(:popular_tags, expires_in: 10.minutes) do
              - tags = Solution.general_tag_counts.order("taggings_count desc")
              - tags.each do |tag|
                = link_to search_solutions_path(tags: tag.name), class: "-m-1.5 p-1.5" do
                  %div{class: "hover:bg-gray-200 -m-1.5 p-1.5"}
                    = tag.name
